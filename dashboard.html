<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDS Platform - Security Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, rgb(60, 75, 97) 0%, rgb(30, 230, 190) 100%);
            color: rgb(255, 255, 255);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            color: rgb(0, 255, 195);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: rgb(0, 232, 247);
            font-size: 1.1em;
        }

        .last-update {
            text-align: center;
            margin-bottom: 20px;
            color: rgb(0, 240, 0);
            font-size: 0.9em;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 195, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 195, 0.3);
        }

        .card h3 {
            color: rgb(0, 232, 247);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .metric-label {
            color: rgb(255, 255, 255);
            font-size: 0.9em;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .metric-value.good { color: rgb(0, 240, 0); }
        .metric-value.warning { color: rgb(255, 165, 0); }
        .metric-value.critical { color: rgb(255, 69, 0); }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(0, 255, 195, 0.3);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 232, 247, 0.3);
        }

        .project-name {
            color: rgb(0, 255, 195);
            font-size: 1.3em;
            font-weight: bold;
        }

        .quality-gate {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .quality-gate.passed {
            background: rgb(0, 240, 0);
            color: rgb(60, 75, 97);
        }

        .quality-gate.failed {
            background: rgb(255, 69, 0);
            color: rgb(255, 255, 255);
        }

        .quality-gate.loading {
            background: rgb(255, 165, 0);
            color: rgb(60, 75, 97);
        }

        .rating {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-left: 5px;
        }

        .rating.A { background: rgb(0, 240, 0); color: rgb(60, 75, 97); }
        .rating.B { background: rgb(173, 255, 47); color: rgb(60, 75, 97); }
        .rating.C { background: rgb(255, 215, 0); color: rgb(60, 75, 97); }
        .rating.D { background: rgb(255, 140, 0); color: rgb(255, 255, 255); }
        .rating.E { background: rgb(255, 69, 0); color: rgb(255, 255, 255); }

        .links {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(0, 232, 247, 0.2);
            border: 1px solid rgb(0, 232, 247);
            border-radius: 6px;
            color: rgb(0, 232, 247);
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(0, 232, 247, 0.4);
            transform: scale(1.05);
        }

        .error-message {
            background: rgba(255, 69, 0, 0.2);
            border: 1px solid rgb(255, 69, 0);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: rgb(255, 255, 255);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: rgb(0, 240, 0);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 255, 195, 0.3);
        }

        .chart-title {
            color: rgb(0, 232, 247);
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è CDS Platform Security Dashboard</h1>
        <div class="subtitle">SonarQube + Snyk + Semgrep + Trivy Aggregated View</div>
        <div class="last-update" id="lastUpdate">Loading...</div>

        <div class="summary-cards" id="summaryCards">
            <div class="card">
                <h3>üìä Overall Quality</h3>
                <div id="overallMetrics" class="loading">Loading...</div>
            </div>
            <div class="card">
                <h3>üêõ Total Bugs</h3>
                <div id="totalBugs" class="loading">Loading...</div>
            </div>
            <div class="card">
                <h3>üîí Vulnerabilities</h3>
                <div id="totalVulns" class="loading">Loading...</div>
            </div>
            <div class="card">
                <h3>üìà Code Coverage</h3>
                <div id="avgCoverage" class="loading">Loading...</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">üìä Security Metrics Trends</div>
            <canvas id="trendsChart"></canvas>
        </div>

        <div class="projects-grid" id="projectsGrid">
            <!-- Projects will be loaded dynamically -->
        </div>

        <div class="card">
            <h3>üîó Quick Links</h3>
            <div class="links">
                <a href="http://localhost:9000" target="_blank" class="btn">SonarQube Dashboard</a>
                <a href="https://app.snyk.io" target="_blank" class="btn">Snyk Dashboard</a>
                <a href="https://github.com/faculax/credit-default-swap/security" target="_blank" class="btn">GitHub Security</a>
                <a href="https://github.com/faculax/credit-default-swap/actions" target="_blank" class="btn">GitHub Actions</a>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SONAR_URL = 'http://localhost:9000';
        const SONAR_TOKEN = ''; // Add your token here or use env variable
        
        const projects = [
            { key: 'credit-default-swap-backend', name: 'Backend Service', icon: '‚öôÔ∏è' },
            { key: 'credit-default-swap-gateway', name: 'Gateway Service', icon: 'üö™' },
            { key: 'credit-default-swap-risk-engine', name: 'Risk Engine', icon: 'üìä' },
            { key: 'credit-default-swap-frontend', name: 'Frontend', icon: 'üé®' }
        ];

        // Fetch data from SonarQube API
        async function fetchSonarQubeData(endpoint) {
            const auth = btoa(`${SONAR_TOKEN}:`);
            try {
                const response = await fetch(`${SONAR_URL}/api/${endpoint}`, {
                    headers: {
                        'Authorization': `Basic ${auth}`
                    }
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        // Get project measures
        async function getProjectMeasures(projectKey) {
            const metrics = [
                'bugs', 'vulnerabilities', 'code_smells', 'coverage',
                'duplicated_lines_density', 'ncloc', 'reliability_rating',
                'security_rating', 'sqale_rating'
            ].join(',');
            
            return await fetchSonarQubeData(
                `measures/component?component=${projectKey}&metricKeys=${metrics}`
            );
        }

        // Get quality gate status
        async function getQualityGateStatus(projectKey) {
            return await fetchSonarQubeData(
                `qualitygates/project_status?projectKey=${projectKey}`
            );
        }

        // Format rating
        function getRatingLetter(value) {
            const ratings = { '1.0': 'A', '2.0': 'B', '3.0': 'C', '4.0': 'D', '5.0': 'E' };
            return ratings[value] || 'N/A';
        }

        // Render project card
        function renderProjectCard(project, measures, qualityGate) {
            const metrics = {};
            if (measures && measures.component && measures.component.measures) {
                measures.component.measures.forEach(m => {
                    metrics[m.metric] = m.value;
                });
            }

            const qgStatus = qualityGate?.projectStatus?.status || 'NONE';
            const qgClass = qgStatus === 'OK' ? 'passed' : qgStatus === 'ERROR' ? 'failed' : 'loading';

            return `
                <div class="project-card">
                    <div class="project-header">
                        <div class="project-name">${project.icon} ${project.name}</div>
                        <div class="quality-gate ${qgClass}">
                            ${qgStatus === 'OK' ? '‚úÖ Passed' : qgStatus === 'ERROR' ? '‚ùå Failed' : '‚è≥ Loading'}
                        </div>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üêõ Bugs</span>
                        <span class="metric-value ${parseInt(metrics.bugs || 0) > 0 ? 'critical' : 'good'}">
                            ${metrics.bugs || '0'}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üîí Vulnerabilities</span>
                        <span class="metric-value ${parseInt(metrics.vulnerabilities || 0) > 0 ? 'critical' : 'good'}">
                            ${metrics.vulnerabilities || '0'}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üßπ Code Smells</span>
                        <span class="metric-value ${parseInt(metrics.code_smells || 0) > 100 ? 'warning' : 'good'}">
                            ${metrics.code_smells || '0'}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">üìà Coverage</span>
                        <span class="metric-value ${parseFloat(metrics.coverage || 0) >= 80 ? 'good' : parseFloat(metrics.coverage || 0) >= 60 ? 'warning' : 'critical'}">
                            ${metrics.coverage ? parseFloat(metrics.coverage).toFixed(1) + '%' : 'N/A'}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Reliability</span>
                        <span class="rating ${getRatingLetter(metrics.reliability_rating)}">
                            ${getRatingLetter(metrics.reliability_rating)}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Security</span>
                        <span class="rating ${getRatingLetter(metrics.security_rating)}">
                            ${getRatingLetter(metrics.security_rating)}
                        </span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Maintainability</span>
                        <span class="rating ${getRatingLetter(metrics.sqale_rating)}">
                            ${getRatingLetter(metrics.sqale_rating)}
                        </span>
                    </div>
                    
                    <div class="links">
                        <a href="${SONAR_URL}/dashboard?id=${project.key}" target="_blank" class="btn">
                            View Dashboard
                        </a>
                        <a href="${SONAR_URL}/project/issues?id=${project.key}&resolved=false" target="_blank" class="btn">
                            View Issues
                        </a>
                    </div>
                </div>
            `;
        }

        // Load all projects
        async function loadProjects() {
            const projectsGrid = document.getElementById('projectsGrid');
            projectsGrid.innerHTML = '<div class="loading">Loading projects...</div>';

            let totalBugs = 0, totalVulns = 0, totalSmells = 0;
            let coverageSum = 0, coverageCount = 0;
            let passedQG = 0;

            const projectCards = await Promise.all(projects.map(async (project) => {
                const [measures, qualityGate] = await Promise.all([
                    getProjectMeasures(project.key),
                    getQualityGateStatus(project.key)
                ]);

                // Aggregate metrics
                if (measures && measures.component && measures.component.measures) {
                    const metrics = {};
                    measures.component.measures.forEach(m => {
                        metrics[m.metric] = m.value;
                    });

                    totalBugs += parseInt(metrics.bugs || 0);
                    totalVulns += parseInt(metrics.vulnerabilities || 0);
                    totalSmells += parseInt(metrics.code_smells || 0);
                    
                    if (metrics.coverage) {
                        coverageSum += parseFloat(metrics.coverage);
                        coverageCount++;
                    }
                }

                if (qualityGate?.projectStatus?.status === 'OK') {
                    passedQG++;
                }

                return renderProjectCard(project, measures, qualityGate);
            }));

            projectsGrid.innerHTML = projectCards.join('');

            // Update summary cards
            document.getElementById('overallMetrics').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Quality Gates Passed</span>
                    <span class="metric-value ${passedQG === projects.length ? 'good' : 'warning'}">
                        ${passedQG}/${projects.length}
                    </span>
                </div>
            `;

            document.getElementById('totalBugs').innerHTML = `
                <div class="metric">
                    <span class="metric-label">All Services</span>
                    <span class="metric-value ${totalBugs > 0 ? 'critical' : 'good'}" style="font-size: 2em;">
                        ${totalBugs}
                    </span>
                </div>
            `;

            document.getElementById('totalVulns').innerHTML = `
                <div class="metric">
                    <span class="metric-label">All Services</span>
                    <span class="metric-value ${totalVulns > 0 ? 'critical' : 'good'}" style="font-size: 2em;">
                        ${totalVulns}
                    </span>
                </div>
            `;

            const avgCoverage = coverageCount > 0 ? (coverageSum / coverageCount).toFixed(1) : 0;
            document.getElementById('avgCoverage').innerHTML = `
                <div class="metric">
                    <span class="metric-label">Average</span>
                    <span class="metric-value ${avgCoverage >= 80 ? 'good' : avgCoverage >= 60 ? 'warning' : 'critical'}" style="font-size: 2em;">
                        ${avgCoverage}%
                    </span>
                </div>
            `;

            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${new Date().toLocaleString()}`;

            // Create trends chart (sample data - you can fetch historical data from SonarQube)
            createTrendsChart();
        }

        // Create trends chart
        function createTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // Sample data - replace with actual historical data from SonarQube API
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Current'],
                    datasets: [
                        {
                            label: 'Bugs',
                            data: [15, 12, 8, 5, 3],
                            borderColor: 'rgb(255, 69, 0)',
                            backgroundColor: 'rgba(255, 69, 0, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Vulnerabilities',
                            data: [8, 6, 4, 2, 1],
                            borderColor: 'rgb(255, 140, 0)',
                            backgroundColor: 'rgba(255, 140, 0, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Coverage %',
                            data: [65, 70, 75, 78, 82],
                            borderColor: 'rgb(0, 240, 0)',
                            backgroundColor: 'rgba(0, 240, 0, 0.1)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgb(255, 255, 255)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: 'rgb(255, 255, 255)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgb(255, 255, 255)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // Load data on page load
        window.addEventListener('load', () => {
            loadProjects();
            
            // Auto-refresh every 5 minutes
            setInterval(loadProjects, 5 * 60 * 1000);
        });

        // Manual refresh button
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                loadProjects();
            }
        });
    </script>
</body>
</html>
