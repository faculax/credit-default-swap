name: Unified Test Reports

on:
  workflow_run:
    workflows: ["Backend Tests with Allure", "Frontend Tests with Allure"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  merge-and-publish:
    name: Merge Reports & Publish to GitHub Pages
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-backend-*
          path: backend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download gateway artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-gateway-*
          path: backend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download risk-engine artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-risk-engine-*
          path: backend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download frontend unit artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-frontend-unit-*
          path: frontend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download frontend integration artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-frontend-integration-*
          path: frontend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: Download frontend E2E artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: allure-results-frontend-e2e-*
          path: frontend-artifacts
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      - name: List all artifacts
        run: |
          echo "## Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Artifacts:" >> $GITHUB_STEP_SUMMARY
          if [ -d "backend-artifacts" ]; then
            ls -la backend-artifacts/ | tee -a $GITHUB_STEP_SUMMARY
            BACKEND_COUNT=$(find backend-artifacts -name '*-result.json' | wc -l)
            echo "Backend test results: $BACKEND_COUNT" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "No backend artifacts found" | tee -a $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Artifacts:" >> $GITHUB_STEP_SUMMARY
          if [ -d "frontend-artifacts" ]; then
            ls -la frontend-artifacts/ | tee -a $GITHUB_STEP_SUMMARY
            FRONTEND_COUNT=$(find frontend-artifacts -name '*-result.json' | wc -l)
            echo "Frontend test results: $FRONTEND_COUNT" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "No frontend artifacts found" | tee -a $GITHUB_STEP_SUMMARY
          fi
      
      - name: Merge all Allure results
        run: |
          mkdir -p allure-results-unified
          
          echo "ðŸ”„ Merging backend service results..."
          if [ -d "backend-artifacts" ]; then
            find backend-artifacts -name '*-result.json' -o -name '*-container.json' -o -name '*-attachment.*' | while read file; do
              cp "$file" allure-results-unified/ 2>/dev/null || true
            done
            echo "âœ… Backend results merged"
          fi
          
          echo "ðŸ”„ Merging frontend test results..."
          if [ -d "frontend-artifacts" ]; then
            find frontend-artifacts -name '*-result.json' -o -name '*-container.json' -o -name '*-attachment.*' | while read file; do
              cp "$file" allure-results-unified/ 2>/dev/null || true
            done
            echo "âœ… Frontend results merged"
          fi
          
          # Count total merged results
          TOTAL_RESULTS=$(find allure-results-unified -name '*-result.json' | wc -l)
          TOTAL_CONTAINERS=$(find allure-results-unified -name '*-container.json' | wc -l)
          TOTAL_ATTACHMENTS=$(find allure-results-unified -name '*-attachment.*' | wc -l)
          
          echo "ðŸ“Š Merge Summary:" | tee -a $GITHUB_STEP_SUMMARY
          echo "- Test results: $TOTAL_RESULTS" | tee -a $GITHUB_STEP_SUMMARY
          echo "- Test containers: $TOTAL_CONTAINERS" | tee -a $GITHUB_STEP_SUMMARY
          echo "- Attachments: $TOTAL_ATTACHMENTS" | tee -a $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_RESULTS" -eq 0 ]; then
            echo "::error::No Allure results found to merge"
            exit 1
          fi
          
          echo "::notice title=Unified Report::Merged $TOTAL_RESULTS test results from backend and frontend"
      
      - name: Restore history from gh-pages
        continue-on-error: true
        run: |
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages -- allure-report/history 2>/dev/null || true
            if [ -d "allure-report/history" ]; then
              cp -r allure-report/history allure-results-unified/history
              echo "::notice::History restored for trend analysis"
            fi
          fi
          git checkout ${{ github.ref_name }}
      
      - name: Install Allure CLI
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          sudo mv allure-2.25.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version
      
      - name: Generate unified Allure report
        run: |
          # Validate JSON files before generating report
          echo "Validating Allure result files..."
          INVALID_FILES=0
          for file in allure-results-unified/*.json; do
            if [ -f "$file" ]; then
              if ! jq empty "$file" 2>/dev/null; then
                echo "::warning::Invalid JSON file: $file"
                INVALID_FILES=$((INVALID_FILES + 1))
                mv "$file" "$file.invalid"
              fi
            fi
          done
          
          if [ $INVALID_FILES -gt 0 ]; then
            echo "::warning::Moved $INVALID_FILES invalid JSON files"
          fi
          
          # Ensure executor.json exists to prevent NullPointerException
          if [ ! -f "allure-results-unified/executor.json" ]; then
            cat > allure-results-unified/executor.json << EOF
          {
            "name": "GitHub Actions",
            "type": "github",
            "buildName": "Run #${{ github.run_number }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "reportUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/",
            "reportName": "Unified Test Report"
          }
          EOF
          fi
          
          # Generate report with better error handling
          if ! allure generate allure-results-unified --clean -o allure-report; then
            echo "::error::Allure report generation failed"
            echo "Listing allure-results-unified contents:"
            ls -la allure-results-unified/
            exit 1
          fi
          
          echo "::notice::Unified Allure HTML report generated successfully"
      
      - name: Add comprehensive metadata
        run: |
          # Create metadata JSON
          cat > allure-report/metadata.json << EOF
          {
            "projectName": "CDS Platform",
            "buildNumber": "${{ github.run_number }}",
            "commitSha": "${{ github.sha }}",
            "commitShort": "${GITHUB_SHA:0:7}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repositoryUrl": "${{ github.server_url }}/${{ github.repository }}",
            "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "services": {
              "backend": ["backend-service", "gateway", "risk-engine"],
              "frontend": ["unit-tests", "integration-tests", "e2e-tests"]
            },
            "reportType": "unified"
          }
          EOF
          
          # Create build info file
          cat > allure-report/BUILD_INFO.txt << EOF
          CDS Platform - Unified Test Report
          =====================================
          Build: #${{ github.run_number }}
          Commit: ${GITHUB_SHA:0:7}
          Branch: ${{ github.ref_name }}
          Generated: $(date -u)
          
          Services Included:
          - Backend Service
          - Gateway Service  
          - Risk Engine
          - Frontend (Unit + Integration + E2E)
          
          Report URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
          EOF
          
          echo "âœ… Metadata added to report"
      
      - name: Add landing page
        run: |
          # Copy landing page to root of report
          cp docs/reporting/landing-page.html allure-report/landing.html
          
          # Rename Allure's index.html to report.html
          mv allure-report/index.html allure-report/report.html
          
          # Copy landing page as new index.html
          cp docs/reporting/landing-page.html allure-report/index.html
          
          # Update link in landing page to point to report.html
          sed -i 's/href="index.html"/href="report.html"/g' allure-report/index.html
          
          echo "âœ… Landing page added as entry point"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'allure-report'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Unified Test Report Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Report URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Included:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend Service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gateway Service" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Risk Engine" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend (Unit + Integration + E2E)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ—ï¸ **Build**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
