name: Security Scanning

on:
  pull_request:
  push:
    branches:
      - 'release/**'
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  secrets-scan:
    name: Secrets scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run gitleaks
        uses: zricethezav/gitleaks-action@v1
        with:
          args: detect --source . --exit-code 1 --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  semgrep-scan:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    needs: secrets-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install semgrep
        run: python -m pip install --upgrade pip semgrep

      - name: Run Semgrep
        run: semgrep --config auto --timeout 120 --error

  note-heavy-scans:
    name: Heavy SAST (optional/Release-only)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run CodeQL (Java + TypeScript)
        uses: github/codeql-action/init@v2
        with:
          languages: 'java, javascript'

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
