name: Backend Tests

on:
  pull_request:
    branches: [main, develop, unified-testing-reporting]
    paths:
      - 'backend/**'
      - 'gateway/**'
      - 'risk-engine/**'
      - '.github/workflows/backend-tests.yml'
  push:
    branches: [main, develop, unified-testing-reporting]
    paths:
      - 'backend/**'
      - 'gateway/**'
      - 'risk-engine/**'
      - '.github/workflows/backend-tests.yml'
  workflow_dispatch: # Allow manual trigger

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx2048m -Xms512m

jobs:
  # Job 1: Backend Service (CDS Platform)
  backend-service-tests:
    name: Backend Service Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better test analysis

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-backend-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-backend-
            ${{ runner.os }}-maven-

      - name: Run backend tests
        id: backend-tests
        working-directory: ./backend
        run: |
          echo "::group::Running Backend Tests"
          mvn clean test -B
          echo "::endgroup::"
          
          # Extract test results summary
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -oP 'failures="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -oP 'errors="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            
            echo "tests=$TESTS" >> $GITHUB_OUTPUT
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            
            echo "::notice title=Backend Tests::Tests: $TESTS, Failures: $FAILURES, Errors: $ERRORS, Skipped: $SKIPPED"
          fi

      - name: Verify Allure results exist
        working-directory: ./backend
        run: |
          if [ ! -d "target/allure-results" ]; then
            echo "::error::Allure results directory not found at backend/target/allure-results"
            exit 1
          fi
          
          RESULT_COUNT=$(find target/allure-results -name '*-result.json' | wc -l)
          echo "::notice title=Allure Results::Found $RESULT_COUNT test result files"
          
          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "::error::No Allure result files found"
            exit 1
          fi

      - name: Upload backend Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-backend-${{ github.run_number }}
          path: backend/target/allure-results/
          retention-days: 30
          if-no-files-found: error

      - name: Upload backend test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-backend-${{ github.run_number }}
          path: backend/target/surefire-reports/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "### Backend Service Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.backend-tests.outputs.tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | ${{ steps.backend-tests.outputs.failures }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.backend-tests.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.backend-tests.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.backend-tests.outputs.failures }}" -gt 0 ] || [ "${{ steps.backend-tests.outputs.errors }}" -gt 0 ]; then
            echo "âŒ Backend tests failed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All backend tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: Gateway Service
  gateway-service-tests:
    name: Gateway Service Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-gateway-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-gateway-
            ${{ runner.os }}-maven-

      - name: Run gateway tests
        id: gateway-tests
        working-directory: ./gateway
        run: |
          echo "::group::Running Gateway Tests"
          mvn clean test -B
          echo "::endgroup::"
          
          # Extract test results summary
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -oP 'failures="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -oP 'errors="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            
            echo "tests=$TESTS" >> $GITHUB_OUTPUT
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            
            echo "::notice title=Gateway Tests::Tests: $TESTS, Failures: $FAILURES, Errors: $ERRORS, Skipped: $SKIPPED"
          fi

      - name: Verify Allure results exist
        working-directory: ./gateway
        run: |
          if [ ! -d "target/allure-results" ]; then
            echo "::error::Allure results directory not found at gateway/target/allure-results"
            exit 1
          fi
          
          RESULT_COUNT=$(find target/allure-results -name '*-result.json' | wc -l)
          echo "::notice title=Allure Results::Found $RESULT_COUNT test result files"
          
          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "::error::No Allure result files found"
            exit 1
          fi

      - name: Upload gateway Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-gateway-${{ github.run_number }}
          path: gateway/target/allure-results/
          retention-days: 30
          if-no-files-found: error

      - name: Upload gateway test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-gateway-${{ github.run_number }}
          path: gateway/target/surefire-reports/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "### Gateway Service Test Results ðŸŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.gateway-tests.outputs.tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | ${{ steps.gateway-tests.outputs.failures }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.gateway-tests.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.gateway-tests.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.gateway-tests.outputs.failures }}" -gt 0 ] || [ "${{ steps.gateway-tests.outputs.errors }}" -gt 0 ]; then
            echo "âŒ Gateway tests failed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All gateway tests passed!" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 3: Risk Engine Service
  risk-engine-tests:
    name: Risk Engine Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Risk engine has known test failures (tracked separately)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-risk-engine-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-risk-engine-
            ${{ runner.os }}-maven-

      - name: Run risk-engine tests
        id: risk-engine-tests
        working-directory: ./risk-engine
        run: |
          echo "::group::Running Risk Engine Tests"
          mvn clean test -B || true  # Allow test failures (known issues)
          echo "::endgroup::"
          
          # Extract test results summary
          if [ -f target/surefire-reports/TEST-*.xml ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            FAILURES=$(grep -oP 'failures="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            ERRORS=$(grep -oP 'errors="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            SKIPPED=$(grep -oP 'skipped="\K[0-9]+' target/surefire-reports/TEST-*.xml | awk '{s+=$1} END {print s}')
            
            echo "tests=$TESTS" >> $GITHUB_OUTPUT
            echo "failures=$FAILURES" >> $GITHUB_OUTPUT
            echo "errors=$ERRORS" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            
            echo "::warning title=Risk Engine Tests::Tests: $TESTS, Failures: $FAILURES, Errors: $ERRORS, Skipped: $SKIPPED (Known issues - see README)"
          fi

      - name: Verify Allure results exist
        working-directory: ./risk-engine
        run: |
          if [ ! -d "target/allure-results" ]; then
            echo "::warning::Allure results directory not found at risk-engine/target/allure-results"
            exit 0  # Don't fail - continue-on-error handles this
          fi
          
          RESULT_COUNT=$(find target/allure-results -name '*-result.json' 2>/dev/null | wc -l)
          echo "::notice title=Allure Results::Found $RESULT_COUNT test result files"

      - name: Upload risk-engine Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-risk-engine-${{ github.run_number }}
          path: risk-engine/target/allure-results/
          retention-days: 30
          if-no-files-found: warn  # Warn instead of error for risk-engine

      - name: Upload risk-engine test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: surefire-reports-risk-engine-${{ github.run_number }}
          path: risk-engine/target/surefire-reports/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "### Risk Engine Service Test Results âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.risk-engine-tests.outputs.tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failures | ${{ steps.risk-engine-tests.outputs.failures }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.risk-engine-tests.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.risk-engine-tests.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** Risk engine has known test failures (7 out of 17 tests)." >> $GITHUB_STEP_SUMMARY
          echo "These are tracked separately and do not block the build." >> $GITHUB_STEP_SUMMARY
          echo "See [risk-engine/README.md](../risk-engine/README.md) for details." >> $GITHUB_STEP_SUMMARY

  # Job 4: Combined Summary
  backend-summary:
    name: Backend Test Summary
    runs-on: ubuntu-latest
    needs: [backend-service-tests, gateway-service-tests, risk-engine-tests]
    if: always()
    
    steps:
      - name: Generate combined summary
        run: |
          echo "# ðŸ“Š Backend Services Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Service Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend status
          if [ "${{ needs.backend-service-tests.result }}" == "success" ]; then
            echo "- âœ… **Backend Service:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Backend Service:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Gateway status
          if [ "${{ needs.gateway-service-tests.result }}" == "success" ]; then
            echo "- âœ… **Gateway Service:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Gateway Service:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Risk engine status (show warning since continue-on-error is true)
          if [ "${{ needs.risk-engine-tests.result }}" == "success" ]; then
            echo "- âœ… **Risk Engine:** PASSED (Unexpected - please verify)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ **Risk Engine:** Has known issues (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download Allure results to generate HTML report locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Download artifacts from GitHub Actions UI" >> $GITHUB_STEP_SUMMARY
          echo "# Extract to workspace root, then:" >> $GITHUB_STEP_SUMMARY
          echo "mvn allure:serve -pl backend" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **Available Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`allure-results-backend-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`allure-results-gateway-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`allure-results-risk-engine-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`surefire-reports-backend-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`surefire-reports-gateway-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`surefire-reports-risk-engine-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Check critical services status
        run: |
          if [ "${{ needs.backend-service-tests.result }}" != "success" ] || [ "${{ needs.gateway-service-tests.result }}" != "success" ]; then
            echo "::error::Critical backend services have test failures"
            exit 1
          fi
          echo "::notice::All critical backend services passed tests"

  # Job 5: Deploy to GitHub Pages (main branch only)
  deploy-pages:
    name: Deploy Reports to GitHub Pages
    runs-on: ubuntu-latest
    needs: [backend-service-tests, gateway-service-tests, risk-engine-tests]
    if: github.ref == 'refs/heads/main' && (needs.backend-service-tests.result == 'success' || needs.gateway-service-tests.result == 'success')
    
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source
      contents: read    # to checkout code
    
    # Deploy to the github-pages environment
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Download all Allure artifacts
        uses: actions/download-artifact@v4
        with:
          path: allure-artifacts
          pattern: allure-results-*

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la allure-artifacts/
          find allure-artifacts -type f -name '*-result.json' | wc -l

      - name: Merge Allure results
        run: |
          # Create merged results directory
          mkdir -p allure-results-merged
          
          # Copy all result files from all services
          echo "Merging Allure results from all services..."
          if [ -d "allure-artifacts/allure-results-backend-${{ github.run_number }}" ]; then
            cp -r allure-artifacts/allure-results-backend-${{ github.run_number }}/* allure-results-merged/ 2>/dev/null || true
            echo "âœ“ Backend results copied"
          fi
          
          if [ -d "allure-artifacts/allure-results-gateway-${{ github.run_number }}" ]; then
            cp -r allure-artifacts/allure-results-gateway-${{ github.run_number }}/* allure-results-merged/ 2>/dev/null || true
            echo "âœ“ Gateway results copied"
          fi
          
          if [ -d "allure-artifacts/allure-results-risk-engine-${{ github.run_number }}" ]; then
            cp -r allure-artifacts/allure-results-risk-engine-${{ github.run_number }}/* allure-results-merged/ 2>/dev/null || true
            echo "âœ“ Risk engine results copied"
          fi
          
          # Count merged results
          RESULT_COUNT=$(find allure-results-merged -name '*-result.json' | wc -l)
          echo "::notice title=Merged Results::Total test results: $RESULT_COUNT"
          
          if [ "$RESULT_COUNT" -eq 0 ]; then
            echo "::error::No Allure results found to merge"
            exit 1
          fi

      - name: Download previous history (if exists)
        continue-on-error: true
        run: |
          # Try to fetch previous report history from gh-pages branch
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git rev-parse --verify gh-pages >/dev/null 2>&1; then
            git checkout gh-pages -- allure-report/history 2>/dev/null || true
            if [ -d "allure-report/history" ]; then
              cp -r allure-report/history allure-results-merged/history
              echo "::notice::Previous history restored for trend analysis"
            fi
          fi
          git checkout ${{ github.ref_name }}

      - name: Generate Allure HTML report
        run: |
          # Install Allure CLI
          wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
          tar -zxf allure-2.25.0.tgz
          
          # Generate report from merged results
          ./allure-2.25.0/bin/allure generate allure-results-merged --clean -o allure-report
          
          echo "::notice::Allure HTML report generated"

      - name: Add metadata to report
        run: |
          # Create metadata file
          cat > allure-report/metadata.json << EOF
          {
            "buildNumber": "${{ github.run_number }}",
            "commitSha": "${{ github.sha }}",
            "commitShort": "${GITHUB_SHA:0:7}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repositoryUrl": "${{ github.server_url }}/${{ github.repository }}",
            "runUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF
          
          # Create simple index redirect if needed (Allure generates index.html)
          if [ ! -f "allure-report/index.html" ]; then
            echo "::error::Allure did not generate index.html"
            exit 1
          fi
          
          echo "Build #${{ github.run_number }} - Commit ${GITHUB_SHA:0:7}" > allure-report/BUILD_INFO.txt
          echo "Generated: $(date -u)" >> allure-report/BUILD_INFO.txt

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'allure-report'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Add Pages URL to summary
        run: |
          echo "# ðŸš€ Reports Published to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Allure Report URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Information:**" >> $GITHUB_STEP_SUMMARY
          echo "- Build: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> $GITHUB_STEP_SUMMARY
